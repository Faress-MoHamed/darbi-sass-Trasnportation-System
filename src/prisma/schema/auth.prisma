// ============================================================================
// Authentication & Authorization
// ============================================================================

model AccessToken {
  id               String    @id @default(uuid())
  token            String    @unique
  refreshToken     String    @unique @map("refresh_token")
  userId           String    @map("user_id") @db.Uuid
  user             User      @relation(fields: [userId], references: [id])
  createdAt        DateTime  @default(now()) @map("created_at")
  expiresAt        DateTime? @map("expires_at")
  refreshExpiresAt DateTime? @map("refresh_expires_at")
  deletedAt        DateTime? @map("deleted_at")

  @@map("access_tokens")
}

model Otp {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  code      String    @db.VarChar(10)
  token     String?   @db.Text()
  expiresAt DateTime  @map("expires_at")
  attempts  Int       @default(0)
  verified  Boolean   @default(false)
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@index([token])
  @@map("otp")
}

model Role {
  id          String    @id @default(uuid())
  type        RoleType
  tenantId    String    @map("tenant_id") @db.Uuid
  name        String    @db.VarChar(100)
  description String?   @db.Text
  deletedAt   DateTime? @map("deleted_at")

  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@unique([tenantId, type])
  @@index([tenantId])
  @@map("roles")
}

model Permission {
  id          Int     @id @default(autoincrement())
  key         String  @unique @db.VarChar(100)
  description String? @db.Text
  deletedAt   DateTime? @map("deleted_at")

  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       String    @map("role_id")
  permissionId Int       @map("permission_id")
  deletedAt    DateTime? @map("deleted_at")

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  userId    String    @map("user_id") @db.Uuid
  roleId    String    @map("role_id")
  tenantId  String    @map("tenant_id") @db.Uuid
  deletedAt DateTime? @map("deleted_at")

  user   User   @relation(fields: [userId], references: [id])
  role   Role   @relation(fields: [roleId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@id([userId, roleId, tenantId])
  @@index([tenantId])
  @@map("user_roles")
}