// ============================================================================
// Pricing Module
// ============================================================================

enum PricingType {
  flat_rate
  distance_based
  station_based
  dynamic
  time_based
}

enum PricingStatus {
  active
  inactive
  scheduled
}

enum DiscountType {
  percentage
  fixed_amount
}

model PricingRule {
  id          String        @id @default(uuid()) @db.Uuid
  tenantId    String        @map("tenant_id") @db.Uuid
  name        String        @db.VarChar(150)
  description String?       @db.Text
  type        PricingType
  status      PricingStatus @default(active)
  priority    Int           @default(0) // Higher priority rules apply first
  isDefault   Boolean       @default(false) @map("is_default")
  
  // Flat rate pricing
  basePrice   Decimal?      @map("base_price") @db.Decimal(10, 2)
  
  // Distance-based pricing
  pricePerKm  Decimal?      @map("price_per_km") @db.Decimal(10, 2)
  minPrice    Decimal?      @map("min_price") @db.Decimal(10, 2)
  maxPrice    Decimal?      @map("max_price") @db.Decimal(10, 2)
  
  // Time-based pricing (peak hours)
  peakMultiplier Decimal?   @map("peak_multiplier") @db.Decimal(3, 2)
  peakStartTime  String?    @map("peak_start_time") @db.VarChar(5) // HH:MM
  peakEndTime    String?    @map("peak_end_time") @db.VarChar(5)   // HH:MM
  
  // Scheduling
  validFrom   DateTime?     @map("valid_from")
  validUntil  DateTime?     @map("valid_until")
  
  // Days of week (JSON array of day numbers: 0=Sunday, 6=Saturday)
  applicableDays Json?      @map("applicable_days")
  
  // Metadata for custom rules
  metadata    Json?
  
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  deletedAt   DateTime?     @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  
  routePricing     RoutePricing[]
  stationPricing   StationPricing[]
  tripPricing      TripPricing[]
  
  @@index([tenantId, status])
  @@index([type, status])
  @@index([priority])
  @@map("pricing_rules")
}

model RoutePricing {
  id            String      @id @default(uuid()) @db.Uuid
  pricingRuleId String      @map("pricing_rule_id") @db.Uuid
  routeId       String      @map("route_id") @db.Uuid
  basePrice     Decimal     @map("base_price") @db.Decimal(10, 2)
  currency      String      @default("EGP") @db.VarChar(3)
  deletedAt     DateTime?   @map("deleted_at")

  pricingRule PricingRule @relation(fields: [pricingRuleId], references: [id])
  route       Route       @relation(fields: [routeId], references: [id])

  @@unique([pricingRuleId, routeId])
  @@index([routeId])
  @@map("route_pricing")
}

model StationPricing {
  id              String      @id @default(uuid()) @db.Uuid
  pricingRuleId   String      @map("pricing_rule_id") @db.Uuid
  routeId         String      @map("route_id") @db.Uuid
  fromStationId   String      @map("from_station_id") @db.Uuid
  toStationId     String      @map("to_station_id") @db.Uuid
  price           Decimal     @db.Decimal(10, 2)
  stationCount    Int         @map("station_count") // Number of stations between
  currency        String      @default("EGP") @db.VarChar(3)
  deletedAt       DateTime?   @map("deleted_at")

  pricingRule  PricingRule @relation(fields: [pricingRuleId], references: [id])
  route        Route       @relation(fields: [routeId], references: [id])
  fromStation  Station     @relation("FromStation", fields: [fromStationId], references: [id])
  toStation    Station     @relation("ToStation", fields: [toStationId], references: [id])

  @@unique([pricingRuleId, routeId, fromStationId, toStationId])
  @@index([routeId])
  @@index([fromStationId])
  @@index([toStationId])
  @@map("station_pricing")
}

model TripPricing {
  id            String      @id @default(uuid()) @db.Uuid
  tripId        String      @map("trip_id") @db.Uuid
  pricingRuleId String?     @map("pricing_rule_id") @db.Uuid
  basePrice     Decimal     @map("base_price") @db.Decimal(10, 2)
  finalPrice    Decimal     @map("final_price") @db.Decimal(10, 2)
  currency      String      @default("EGP") @db.VarChar(3)
  appliedAt     DateTime    @default(now()) @map("applied_at")
  deletedAt     DateTime?   @map("deleted_at")

  trip        Trip         @relation(fields: [tripId], references: [id])
  pricingRule PricingRule? @relation(fields: [pricingRuleId], references: [id])

  @@index([tripId])
  @@index([pricingRuleId])
  @@map("trip_pricing")
}

model Discount {
  id          String       @id @default(uuid()) @db.Uuid
  tenantId    String       @map("tenant_id") @db.Uuid
  code        String       @unique @db.VarChar(50)
  name        String       @db.VarChar(150)
  description String?      @db.Text
  type        DiscountType
  value       Decimal      @db.Decimal(10, 2)
  minAmount   Decimal?     @map("min_amount") @db.Decimal(10, 2)
  maxDiscount Decimal?     @map("max_discount") @db.Decimal(10, 2)
  usageLimit  Int?         @map("usage_limit")
  usageCount  Int          @default(0) @map("usage_count")
  validFrom   DateTime     @map("valid_from")
  validUntil  DateTime     @map("valid_until")
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  deletedAt   DateTime?    @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  
  bookingDiscounts BookingDiscount[]

  @@index([tenantId, isActive])
  @@index([code])
  @@index([validFrom, validUntil])
  @@map("discounts")
}


