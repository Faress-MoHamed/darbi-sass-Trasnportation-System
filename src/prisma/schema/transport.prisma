// ============================================================================
// Transport Management (Drivers, Buses, Routes, Trips)
// ============================================================================

model Driver {
  id            String       @id @default(uuid()) @db.Uuid
  tenantId      String       @map("tenant_id") @db.Uuid
  userId        String       @unique @map("user_id") @db.Uuid
  licenseNumber String?      @map("license_number") @db.VarChar(50)
  status        DriverStatus
  rating        Decimal?     @db.Decimal(2, 1)
  lastSeenAt    DateTime?    @map("last_seen_at")
  isOnline      Boolean      @default(false)
  deletedAt     DateTime?    @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  trips             Trip[]
  emergencyAlerts   EmergencyAlert[]
  customFieldValues DriverCustomFieldValue[]

  @@index([tenantId])
  @@index([status])
  @@map("drivers")
}

model Bus {
  id                String    @id @default(uuid()) @db.Uuid
  tenantId          String    @unique() @map("tenant_id") @db.Uuid
  busNumber         String    @map("bus_number") @db.VarChar(50)
  capacity          Int?
  type              String?   @db.VarChar(50)
  status            BusStatus
  gpsTrackerId      String?   @map("gps_tracker_id") @db.VarChar(100)
  maintenanceStatus String?   @map("maintenance_status") @db.VarChar(100)
  deletedAt         DateTime? @map("deleted_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  trips             Trip[]
  gpsData           GpsData[]
  busStatusLogs     BusStatusLog[]
  customFieldValues BusCustomFieldValue[]

  @@index([tenantId])
  @@index([busNumber])
  @@index([status])
  @@map("buses")
}

model Route {
  id            String    @id @default(uuid()) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  name          String    @db.VarChar(150)
  distanceKm    Decimal?  @map("distance_km") @db.Decimal(6, 2)
  estimatedTime String?   @map("estimated_time") @db.VarChar(8)
  active        Boolean?
  deletedAt     DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  stations          Station[]
  trips             Trip[]
  customFieldValues RouteCustomFieldValue[]

  @@index([tenantId])
  @@index([active])
  @@map("routes")
}

model Station {
  id        String    @id @default(uuid()) @db.Uuid
  tenantId  String    @map("tenant_id") @db.Uuid
  name      String    @db.VarChar(150)
  latitude  Decimal?  @db.Decimal(10, 6)
  longitude Decimal?  @db.Decimal(10, 6)
  routeId   String?   @map("route_id") @db.Uuid
  sequence  Int?
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  route  Route? @relation(fields: [routeId], references: [id])

  tripStations TripStation[]

  @@index([tenantId])
  @@index([routeId])
  @@map("stations")
}

model Trip {
  id             String     @id @default(uuid()) @db.Uuid
  tenantId       String     @map("tenant_id") @db.Uuid
  routeId        String?    @map("route_id") @db.Uuid
  busId          String?    @map("bus_id") @db.Uuid
  driverId       String?    @map("driver_id") @db.Uuid
  departureTime  DateTime?  @map("departure_time")
  arrivalTime    DateTime?  @map("arrival_time")
  status         TripStatus
  availableSeats Int?       @map("available_seats")
  notes          String?    @db.Text
  deletedAt      DateTime?  @map("deleted_at")

  tenant Tenant  @relation(fields: [tenantId], references: [id])
  route  Route?  @relation(fields: [routeId], references: [id])
  bus    Bus?    @relation(fields: [busId], references: [id])
  driver Driver? @relation(fields: [driverId], references: [id])

  tripStations      TripStation[]
  tripLogs          TripLog[]
  bookings          Booking[]
  emergencyAlerts   EmergencyAlert[]
  tripPerformance   TripPerformance[]
  customFieldValues TripCustomFieldValue[]

  @@index([tenantId])
  @@index([routeId])
  @@index([busId])
  @@index([driverId])
  @@index([status])
  @@index([departureTime])
  @@index([tenantId, status])
  @@index([tenantId, departureTime])
  @@index([routeId, departureTime])
  @@index([busId, departureTime])
  @@index([driverId, departureTime])
  @@index([tenantId, status, departureTime])
  @@map("trips")
}

model TripStation {
  tripId               String    @map("trip_id") @db.Uuid
  stationId            String    @map("station_id") @db.Uuid
  scheduledArrivalTime DateTime? @map("scheduled_arrival_time")
  actualArrivalTime    DateTime? @map("actual_arrival_time")
  deletedAt            DateTime? @map("deleted_at")

  trip    Trip    @relation(fields: [tripId], references: [id])
  station Station @relation(fields: [stationId], references: [id])

  @@id([tripId, stationId])
  @@map("trip_stations")
}

model TripLog {
  id              BigInt    @id @default(autoincrement())
  tripId          String    @map("trip_id") @db.Uuid
  busLocationLat  Decimal?  @map("bus_location_lat") @db.Decimal(10, 6)
  busLocationLng  Decimal?  @map("bus_location_lng") @db.Decimal(10, 6)
  speed           Decimal?  @db.Decimal(5, 2)
  passengersCount Int?      @map("passengers_count")
  timestamp       DateTime  @default(now())
  deletedAt       DateTime? @map("deleted_at")

  trip Trip @relation(fields: [tripId], references: [id])

  @@index([tripId])
  @@index([timestamp])
  @@map("trip_logs")
}

model GpsData {
  id        BigInt    @id @default(autoincrement())
  busId     String    @map("bus_id") @db.Uuid
  latitude  Decimal?  @db.Decimal(10, 6)
  longitude Decimal?  @db.Decimal(10, 6)
  speed     Decimal?  @db.Decimal(5, 2)
  timestamp DateTime  @default(now())
  deletedAt DateTime? @map("deleted_at")

  bus Bus @relation(fields: [busId], references: [id])

  @@map("gps_data")
}

model BusStatusLog {
  id        BigInt             @id @default(autoincrement())
  busId     String             @map("bus_id") @db.Uuid
  status    BusOperationStatus
  timestamp DateTime           @default(now())
  deletedAt DateTime?          @map("deleted_at")

  bus Bus @relation(fields: [busId], references: [id])

  @@map("bus_status_logs")
}

model MapLayer {
  id        Int          @id @default(autoincrement())
  tenantId  String       @map("tenant_id") @db.Uuid
  type      MapLayerType
  data      Json?
  visible   Boolean?
  updatedAt DateTime     @updatedAt @map("updated_at")
  deletedAt DateTime?    @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("map_layers")
}