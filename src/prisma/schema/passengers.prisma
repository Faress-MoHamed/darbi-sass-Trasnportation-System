// ============================================================================
// Passengers, Bookings & Subscriptions
// ============================================================================

model Passenger {
  id                 String              @id @default(uuid()) @db.Uuid
  tenantId           String?             @map("tenant_id") @db.Uuid
  userId             String              @map("user_id") @db.Uuid
  subscriptionStatus SubscriptionStatus? @map("subscription_status")
  pointsBalance      Int?                @map("points_balance")
  deletedAt          DateTime?           @map("deleted_at")

  tenant Tenant? @relation(fields: [tenantId], references: [id])
  user   User    @relation(fields: [userId], references: [id])

  customFieldValues PassengerCustomFieldValue[]
  bookings          Booking[]
  subscriptions     Subscription[]

  @@unique([tenantId, userId])
  @@unique([id, tenantId])
  @@index([tenantId])
  @@map("passengers")
}

model Booking {
  id           String        @id @default(uuid()) @db.Uuid
  tenantId     String        @map("tenant_id") @db.Uuid
  tripId       String?       @map("trip_id") @db.Uuid
  passengerId  String?       @map("passenger_id") @db.Uuid
  seatNumber   String?       @map("seat_number") @db.VarChar(10)
  status       BookingStatus
  ticketNumber String?       @map("ticket_number") @db.VarChar(100)
  bookingDate  DateTime?     @map("booking_date")
  paymentId    String?       @map("payment_id") @db.Uuid
  deletedAt    DateTime?     @map("deleted_at")
  price            Decimal?  @db.Decimal(10, 2)
  discountAmount   Decimal?  @map("discount_amount") @db.Decimal(10, 2)
  finalPrice       Decimal?  @map("final_price") @db.Decimal(10, 2)
  currency         String    @default("EGP") @db.VarChar(3)
  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  trip      Trip?      @relation(fields: [tripId], references: [id])
  payment   Payment?   @relation(fields: [paymentId], references: [id])
  passenger Passenger? @relation(fields: [passengerId, tenantId], references: [id, tenantId])

  tickets           Ticket[]
  customFieldValues BookingCustomFieldValue[]
  bookingDiscounts BookingDiscount[]

  @@index([tenantId])
  @@index([tripId])
  @@index([passengerId])
  @@index([status])
  @@index([bookingDate])
  @@index([paymentId])
  @@index([tenantId, status])
  @@index([passengerId, status])
  @@index([tripId, status])
  @@map("bookings")
}

model Subscription {
  id          String             @id @default(uuid()) @db.Uuid
  tenantId    String             @map("tenant_id") @db.Uuid
  passengerId String?            @map("passenger_id") @db.Uuid
  planName    String?            @map("plan_name") @db.VarChar(100)
  startDate   DateTime?          @map("start_date") @db.Date
  endDate     DateTime?          @map("end_date") @db.Date
  status      SubscriptionStatus
  price       Decimal?           @db.Decimal(10, 2)
  deletedAt   DateTime?          @map("deleted_at")

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  passenger Passenger? @relation(fields: [passengerId], references: [id])

  @@index([tenantId])
  @@index([passengerId])
  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

model Ticket {
  id        String    @id @default(uuid()) @db.Uuid
  tenantId  String    @map("tenant_id") @db.Uuid
  bookingId String?   @map("booking_id") @db.Uuid
  qrCode    String?   @map("qr_code") @db.Text
  issuedAt  DateTime? @map("issued_at")
  deletedAt DateTime? @map("deleted_at")

  tenant  Tenant   @relation(fields: [tenantId], references: [id])
  booking Booking? @relation(fields: [bookingId], references: [id])

  @@index([tenantId])
  @@index([bookingId])
  @@map("tickets")
}

model LoyaltyPoint {
  id        BigInt    @id @default(autoincrement())
  tenantId  String    @map("tenant_id") @db.Uuid
  userId    String?   @map("user_id") @db.Uuid
  points    Int?
  reason    String?   @db.VarChar(255)
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User?  @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([createdAt])
  @@map("loyalty_points")
}


model BookingDiscount {
  id             String    @id @default(uuid()) @db.Uuid
  bookingId      String    @map("booking_id") @db.Uuid
  discountId     String    @map("discount_id") @db.Uuid
  discountAmount Decimal   @map("discount_amount") @db.Decimal(10, 2)
  appliedAt      DateTime  @default(now()) @map("applied_at")
  deletedAt      DateTime? @map("deleted_at")

  booking  Booking  @relation(fields: [bookingId], references: [id])
  discount Discount @relation(fields: [discountId], references: [id])

  @@unique([bookingId, discountId])
  @@index([discountId])
  @@map("booking_discounts")
}